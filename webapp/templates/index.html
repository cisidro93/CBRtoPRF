<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBZ to PDF Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone {
            transition: all 0.3s ease;
        }

        .drop-zone.dragover {
            background-color: #374151;
            /* gray-700 */
            border-color: #60A5FA;
            /* blue-400 */
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-md bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-center mb-6 text-blue-400">CBZ to PDF Converter</h1>

            <!-- Upload Section -->
            <div id="upload-section">
                <div id="drop-zone"
                    class="drop-zone border-2 border-dashed border-gray-600 rounded-lg p-8 text-center cursor-pointer mb-6 hover:bg-gray-750 hover:border-gray-500">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                    <p class="text-gray-300 mb-1">Click or Drag & Drop</p>
                    <p class="text-xs text-gray-500">CBZ or CBR files</p>
                    <input type="file" id="file-input" class="hidden" accept=".cbz,.cbr"
                        aria-label="Upload CBZ or CBR file">
                </div>

                <!-- Options -->
                <div class="space-y-4 mb-6">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="compress-check"
                                class="form-checkbox h-4 w-4 text-blue-500 rounded border-gray-600 bg-gray-700 focus:ring-blue-500">
                            <span class="text-sm text-gray-300">Compress Images</span>
                        </label>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="kindle-check"
                                class="form-checkbox h-4 w-4 text-blue-500 rounded border-gray-600 bg-gray-700 focus:ring-blue-500">
                            <span class="text-sm text-gray-300">Send to Kindle</span>
                        </label>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="limit-size-check"
                                class="form-checkbox h-4 w-4 text-blue-500 rounded border-gray-600 bg-gray-700 focus:ring-blue-500"
                                checked>
                            <span class="text-sm text-gray-300">Limit Size</span>
                        </label>
                        <div class="flex items-center space-x-2">
                            <select id="size-preset" aria-label="Select size limit preset"
                                class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-blue-500">
                                <option value="25">25 MB (Gmail)</option>
                                <option value="50">50 MB</option>
                                <option value="100">100 MB</option>
                                <option value="200" selected>200 MB</option>
                                <option value="custom">Custom</option>
                            </select>
                            <input type="number" id="max-size-input" value="200" min="1" max="1000"
                                aria-label="Custom max size in MB"
                                class="w-20 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-right focus:outline-none focus:border-blue-500 hidden">
                        </div>
                    </div>
                </div>

                <button id="convert-btn"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Convert
                </button>
            </div>

            <!-- Progress Section (Hidden by default) -->
            <div id="progress-section" class="hidden">
                <div class="mb-2 flex justify-between text-sm">
                    <span id="status-text" class="text-gray-300">Processing...</span>
                    <span id="percentage-text" class="text-blue-400 font-mono">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300 w-0"></div>
                </div>

                <a id="download-btn" href="#"
                    class="hidden block w-full bg-green-600 hover:bg-green-500 text-white text-center font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Download PDF
                </a>

                <button id="reset-btn"
                    class="hidden mt-3 w-full bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Convert Another
                </button>
            </div>

            <!-- Error Message -->
            <div id="error-msg"
                class="hidden mt-4 p-3 bg-red-900/50 border border-red-700 rounded text-red-200 text-sm text-center">
            </div>

        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const convertBtn = document.getElementById('convert-btn');
        const uploadSection = document.getElementById('upload-section');
        const progressSection = document.getElementById('progress-section');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const percentageText = document.getElementById('percentage-text');
        const downloadBtn = document.getElementById('download-btn');
        const resetBtn = document.getElementById('reset-btn');
        const errorMsg = document.getElementById('error-msg');
        const compressCheck = document.getElementById('compress-check');
        const kindleCheck = document.getElementById('kindle-check');
        const limitSizeCheck = document.getElementById('limit-size-check');
        const maxSizeInput = document.getElementById('max-size-input');
        const sizePreset = document.getElementById('size-preset');

        let selectedFile = null;

        // Toggle max size input
        limitSizeCheck.addEventListener('change', (e) => {
            const enabled = e.target.checked;
            sizePreset.disabled = !enabled;
            maxSizeInput.disabled = !enabled;

            sizePreset.classList.toggle('opacity-50', !enabled);
            maxSizeInput.classList.toggle('opacity-50', !enabled);
        });

        // Handle Preset Change
        sizePreset.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                maxSizeInput.classList.remove('hidden');
                maxSizeInput.focus();
            } else {
                maxSizeInput.classList.add('hidden');
                maxSizeInput.value = e.target.value;
            }
        });

        // Drag & Drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.name.toLowerCase().endsWith('.cbz') && !file.name.toLowerCase().endsWith('.cbr')) {
                showError('Please select a .cbz or .cbr file.');
                return;
            }
            selectedFile = file;
            dropZone.innerHTML = `
                <svg class="w-12 h-12 mx-auto text-green-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-gray-200 font-medium truncate px-4">${file.name}</p>
                <p class="text-xs text-gray-500 mt-1">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            `;
            errorMsg.classList.add('hidden');
        }

        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) {
                showError('Please select a file first.');
                return;
            }

            // UI Transition
            uploadSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            resetBtn.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            progressBar.style.width = '0%';
            percentageText.textContent = '0%';
            statusText.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('compress', compressCheck.checked);
            formData.append('kindle', kindleCheck.checked);
            if (limitSizeCheck.checked) {
                formData.append('max_size_mb', maxSizeInput.value);
            }

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error(await response.text());

                const data = await response.json();
                pollStatus(data.task_id);

            } catch (err) {
                showError(err.message);
                resetUI();
            }
        });

        async function pollStatus(taskId) {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/status/${taskId}`);
                    const data = await res.json();

                    if (data.status === 'processing') {
                        progressBar.style.width = `${data.progress}%`;
                        percentageText.textContent = `${data.progress}%`;
                        statusText.textContent = data.message;
                    } else if (data.status === 'completed') {
                        clearInterval(interval);
                        progressBar.style.width = '100%';
                        percentageText.textContent = '100%';
                        statusText.textContent = 'Done!';

                        downloadBtn.href = data.download_url;
                        downloadBtn.classList.remove('hidden');
                        resetBtn.classList.remove('hidden');
                    } else {
                        clearInterval(interval);
                        showError(data.message);
                        resetBtn.classList.remove('hidden');
                    }
                } catch (err) {
                    clearInterval(interval);
                    showError('Connection lost.');
                    resetBtn.classList.remove('hidden');
                }
            }, 1000);
        }

        resetBtn.addEventListener('click', () => {
            location.reload();
        });

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
        }

        function resetUI() {
            uploadSection.classList.remove('hidden');
            progressSection.classList.add('hidden');
        }

    </script>
</body>

</html>