name: Build iPadOS IPA

on:
  push:
    branches:
      - ios-port
  workflow_dispatch:

jobs:
  build-ipa:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet
          pip install -r requirements_mobile.txt

      - name: Build IPA (Unsigned)
        run: |
          echo "flet" > requirements.txt
          yes | flet build ipa . --verbose
          
      - name: Debug Build Output
        run: |
          echo "Listing build directory..."
          find build -maxdepth 4 || echo "Build dir not found"

      - name: Package Unsigned IPA (Manual)
        run: |
          # If Flet made an xcarchive but no IPA (common for unsigned), we package it manually
          mkdir -p dist
          
          # Try to find the .app inside the xcarchive
          APP_PATH=$(find build -name "Runner.app" | head -n 1)
          
          if [ -n "$APP_PATH" ]; then
            echo "Found app at: $APP_PATH"
            
            # --- MANUAL OVERRIDE: Force Inject Info.plist keys ---
            # Reverting to Build #58 method: Direct Injection. No Merging.
            echo "Injecting CFBundleDocumentTypes (Manual)..."
            # Clear existing if any
            /usr/libexec/PlistBuddy -c "Delete :CFBundleDocumentTypes" "$PLIST" || true
            
            # Create Array
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes array" "$PLIST"
            
            # Item 0 Dict
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0 dict" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:CFBundleTypeName string 'Comic Book Archive'" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:CFBundleTypeRole string 'Editor'" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:LSHandlerRank string 'Owner'" "$PLIST"
            
            # Inner Array of Content Types
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:LSItemContentTypes array" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:LSItemContentTypes:0 string 'com.pkware.zip-archive'" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:LSItemContentTypes:1 string 'public.zip-archive'" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:LSItemContentTypes:2 string 'public.archive'" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:LSItemContentTypes:3 string 'com.macitbetter.cbz-archive'" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:LSItemContentTypes:4 string 'public.data'" "$PLIST"
            
            echo "Injecting UIFileSharingEnabled..."
            /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST" || /usr/libexec/PlistBuddy -c "Set :UIFileSharingEnabled bool true" "$PLIST"
            
            echo "Injecting LSSupportsOpeningDocumentsInPlace..."
            /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST" || /usr/libexec/PlistBuddy -c "Set :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST"
            
            # Note: Priority is Folder Visibility. These keys MUST result in 'true'.
            
            # DEBUG: Print final plist
            echo "--- FINAL INFO.PLIST START ---"
            cat "$PLIST"
            echo "--- FINAL INFO.PLIST END ---"
            # -----------------------------------------------------
            
            mkdir -p Payload
            cp -r "$APP_PATH" Payload/
            zip -r dist/app.ipa Payload
            echo "Successfully packaged dist/app.ipa"
          else
            echo "No Runner.app found. Build likely failed."
            exit 1
          fi

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: dist/*.ipa
